services:

  # Private Network section
  # All the following services are related to the core of the Private Network
  # For more information on these configs, refer to:
  # https://github.com/HathorNetwork/rfcs/blob/master/text/0033-private-network-guide.md
  # Fullnode on 8080 , tx mining service on 8035, cpuminer stratum on 8034

  fullnode:
    image:
      ${HATHOR_LIB_INTEGRATION_TESTS_FULLNODE_IMAGE:-hathornetwork/hathor-core:v0.65.0-alpha.3}
    command: [
      "run_node",
      "--listen", "tcp:40404",
      "--status", "8080",
      "--test-mode-tx-weight",
      "--wallet-index",
      "--allow-mining-without-peers",
      "--unsafe-mode", "nano-testnet-bravo",
      "--data", "./tmp",
      "--nc-indexes",
      "--nc-exec-logs", "all",
    ]
    environment:
      HATHOR_CONFIG_YAML: privnet/conf/privnet.yml
    ports:
      - "8083:8080"
      - "40404:40404"
    volumes:
      - type: bind
        source: ./
        target: /privnet/conf
    networks:
      - hathor-privnet
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; import json; r = urllib.request.urlopen('http://localhost:8080/v1a/status'); body = json.loads(r.read()); assert body['server']['state'] == 'READY'"]
      interval: 5s
      timeout: 10s
      retries: 10

  tx-mining-service:
    image:
      ${HATHOR_LIB_INTEGRATION_TESTS_TXMINING_IMAGE:-hathornetwork/tx-mining-service}
    depends_on:
      fullnode:
        condition: service_healthy
    ports:
      - "8034:8034" # Not mandatory to keep this port open, but helpful for developer machine debugging
      - "8035:8035"
    command: [
      "http://fullnode:8080",
      "--stratum-port=8034",
      "--api-port=8035"
    ]
    networks:
      - hathor-privnet

  cpuminer:
    image: hathornetwork/cpuminer
    depends_on:
      - tx-mining-service
    command: [
      "-a", "sha256d",
      "--coinbase-addr", "WTjhJXzQJETVx7BVXdyZmvk396DRRsubdw", # Refer to test-utils-integration.js, WALLET_CONSTANTS
      "-o", "stratum+tcp://tx-mining-service:8034",
      "--retry-pause", "5", # 5 seconds between retries
      "-t", "1" # Number of threads used to mine
    ]
    networks:
      - hathor-privnet


  # Wallet Service section
  # All the following services are related to the Wallet Service
  # Redis on 6379, MySQL on 3380, Wallet Service Daemon on 8081 and Daemon Websocket on 8082

  mysql:
    image: mysql
    networks:
      - hathor-privnet
    environment:
      MYSQL_ROOT_PASSWORD: hathor
      MYSQL_DATABASE: wallet_service
      MYSQL_USER: wallet_service_user
      MYSQL_PASSWORD: password
      MYSQL_DEFAULT_AUTHENTICATION_PLUGIN: mysql_native_password
    ports:
      - "3380:3306"
    healthcheck:
        test: ["CMD", "mysql", "-h", "mysql", "-u", "wallet_service_user", "-ppassword", "-e", "SELECT 1", "wallet_service"]

  redis:
    image: redis:6.2
    networks:
      - hathor-privnet
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  ws-migrator:
    build:
      context: '/home/tulio/code/wallet-service/'
      dockerfile: 'db/Dockerfile'
      args:
        DB_ENDPOINT: "mysql"
        DB_NAME: "wallet_service"
        DB_USER: "wallet_service_user"
        DB_PASS: "password"
        DB_PORT: 3306
    restart: "no"  # Critical: don't restart migration service
    command: ["/bin/sh", "migrate.sh"]
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_ENDPOINT: "mysql"
      DB_NAME: "wallet_service"
      DB_USER: "wallet_service_user"
      DB_PASS: "password"
      DB_PORT: 3306
    networks:
      - hathor-privnet

  ws-daemon:
    build:
      context: '/home/tulio/code/wallet-service/'
      dockerfile: Dockerfile
    depends_on:
      ws-migrator:
        condition: service_completed_successfully
      fullnode:
        condition: service_healthy
      mysql:
        condition: service_healthy
    environment:
      FULLNODE_HOST: "http://fullnode:8080"
      FULLNODE_NETWORK: "privatenet"
      USE_SSL: "false"
      NEW_TX_SQS: ""
      PUSH_NOTIFICATION_ENABLED: "false"
      WALLET_SERVICE_LAMBDA_ENDPOINT: ""
      ACCOUNT_ID: 1234
      ALERT_MANAGER_TOPIC: "alert-topic"
      ALERT_MANAGER_REGION: "us-east-1"
      APPLICATION_NAME: "hathor-wallet-service"
      DB_ENDPOINT: "mysql"
      DB_NAME: "wallet_service"
      DB_USER: "wallet_service_user"
      DB_PASS: "password"
      DB_PORT: 3306
      STREAM_ID: "f7d9157c-9906-4bd2-bc84-cfb9f5b607d1"
      FULLNODE_PEER_ID: "bdf4fa876f5cdba84be0cab53b21fc9eb45fe4b3d6ede99f493119d37df4e560"

      NODE_ENV: "test-privnet"
      STAGE: "local"
      MAX_ADDRESS_GAP: 10
      NETWORK: "nano-testnet-alpha"
#      BLOCK_REWARD_LOCK: 1
      REDIS_URL: redis://redis:6379
    ports:
      - "8081:8081"
      - "8082:8082"
    networks:
      - hathor-privnet

networks:
  hathor-privnet:

