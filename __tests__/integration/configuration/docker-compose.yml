services:

  # Private Network section
  # All the following services are related to the core of the Private Network
  # For more information on these configs, refer to:
  # https://github.com/HathorNetwork/rfcs/blob/master/text/0033-private-network-guide.md
  # Fullnode on 8080 , tx mining service on 8035, cpuminer stratum on 8034

  fullnode:
    image:
      ${HATHOR_LIB_INTEGRATION_TESTS_FULLNODE_IMAGE:-hathornetwork/hathor-core:v0.65.0-alpha.3}
    command: [
      "run_node",
      "--listen", "tcp:40404",
      "--status", "8080",
      "--test-mode-tx-weight",
      "--wallet-index",
      "--allow-mining-without-peers",
      "--unsafe-mode", "nano-testnet-bravo",
      "--data", "./tmp",
      "--nc-indexes",
      "--nc-exec-logs", "all",
    ]
    environment:
      HATHOR_CONFIG_YAML: privnet/conf/privnet.yml
    ports:
      - "8083:8080"
      - "40404:40404"
    volumes:
      - type: bind
        source: ./
        target: /privnet/conf
    networks:
      - hathor-privnet
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; import json; r = urllib.request.urlopen('http://localhost:8080/v1a/status'); body = json.loads(r.read()); assert body['server']['state'] == 'READY'"]
      interval: 5s
      timeout: 10s
      retries: 10

  tx-mining-service:
    image:
      ${HATHOR_LIB_INTEGRATION_TESTS_TXMINING_IMAGE:-hathornetwork/tx-mining-service}
    depends_on:
      fullnode:
        condition: service_healthy
    ports:
      - "8034:8034" # Not mandatory to keep this port open, but helpful for developer machine debugging
      - "8035:8035"
    command: [
      "http://fullnode:8080",
      "--stratum-port=8034",
      "--api-port=8035"
    ]
    networks:
      - hathor-privnet

  cpuminer:
    image: hathornetwork/cpuminer
    depends_on:
      - tx-mining-service
    command: [
      "-a", "sha256d",
      "--coinbase-addr", "WTjhJXzQJETVx7BVXdyZmvk396DRRsubdw", # Refer to test-utils-integration.js, WALLET_CONSTANTS
      "-o", "stratum+tcp://tx-mining-service:8034",
      "--retry-pause", "5", # 5 seconds between retries
      "-t", "1" # Number of threads used to mine
    ]
    networks:
      - hathor-privnet


  # Wallet Service section
  # All the following services are related to the Wallet Service
  # Redis on 6379, MySQL on 3380, Wallet Service Daemon on 8081 and Daemon Websocket on 8082

  mysql:
    image: mysql
    networks:
      - hathor-privnet
    environment:
      MYSQL_ROOT_PASSWORD: hathor
    ports:
      - "3380:3306"

  redis:
    image: redis:6.2
    networks:
      - hathor-privnet
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  ws-daemon:
    build:
      context: '/Users/tuliomir/code/wallet-service/'
      dockerfile: Dockerfile
    depends_on:
      fullnode:
        condition: service_healthy
    command: [
      "--port", "8081",
      "--fullnode-url", "http://fullnode:8080",
      "--ws-port", "8082"
    ]
    ports:
      - "8081:8081"
      - "8082:8082"
    networks:
      - hathor-privnet

networks:
  hathor-privnet:

