services:

  # Private Network section
  # All the following services are related to the core of the Private Network
  # For more information on these configs, refer to:
  # https://github.com/HathorNetwork/rfcs/blob/master/text/0033-private-network-guide.md
  # Fullnode on 8080 , tx mining service on 8035, cpuminer stratum on 8034

  fullnode:
    image:
      ${HATHOR_LIB_INTEGRATION_TESTS_FULLNODE_IMAGE:-hathornetwork/hathor-core:v0.65.0-alpha.3}
    command: [
      "run_node",
      "--listen", "tcp:40404",
      "--status", "8080",
      "--test-mode-tx-weight",
      "--wallet-index",
      "--allow-mining-without-peers",
      "--unsafe-mode", "nano-testnet-bravo",
      "--data", "./tmp",
      "--nc-indexes",
      "--enable-event-queue",
      "--nc-exec-logs", "all",
    ]
    environment:
      HATHOR_CONFIG_YAML: privnet/conf/privnet.yml
    ports:
      - "8083:8080"
      - "40404:40404"
    volumes:
      - type: bind
        source: ./
        target: /privnet/conf
    networks:
      - hathor-privnet
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; import json; r = urllib.request.urlopen('http://localhost:8080/v1a/status'); body = json.loads(r.read()); assert body['server']['state'] == 'READY'"]
      interval: 5s
      timeout: 10s
      retries: 10

  tx-mining-service:
    image:
      ${HATHOR_LIB_INTEGRATION_TESTS_TXMINING_IMAGE:-hathornetwork/tx-mining-service}
    depends_on:
      fullnode:
        condition: service_healthy
    ports:
      - "8034:8034" # Not mandatory to keep this port open, but helpful for developer machine debugging
      - "8035:8035"
    command: [
      "http://fullnode:8080",
      "--stratum-port=8034",
      "--api-port=8035"
    ]
    networks:
      - hathor-privnet

  cpuminer:
    image: hathornetwork/cpuminer
    depends_on:
      - tx-mining-service
    command: [
      "-a", "sha256d",
      "--coinbase-addr", "WTjhJXzQJETVx7BVXdyZmvk396DRRsubdw", # Refer to test-utils-integration.js, WALLET_CONSTANTS
      "-o", "stratum+tcp://tx-mining-service:8034",
      "--retry-pause", "5", # 5 seconds between retries
      "-t", "1" # Number of threads used to mine
    ]
    networks:
      - hathor-privnet


  # Wallet Service section
  # All the following services are related to the Wallet Service
  # Redis on 6379, MySQL on 3380, Wallet Service Daemon on 8081 and Daemon Websocket on 8082

  mysql:
    image: centos/mysql-80-centos7 # Necessary to use specific authentication protocol
    networks:
      - hathor-privnet
    environment:
      MYSQL_ROOT_PASSWORD: hathor
      MYSQL_DATABASE: wallet_service
      MYSQL_USER: wallet_service_user
      MYSQL_PASSWORD: password
      MYSQL_DEFAULT_AUTHENTICATION_PLUGIN: mysql_native_password
    ports:
      - "3380:3306"
    healthcheck:
        test: ["CMD", "mysql", "-h", "mysql", "-u", "wallet_service_user", "-ppassword", "-e", "SELECT 1", "wallet_service"]

  redis:
    image: redis:6.2
    networks:
      - hathor-privnet
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  ws-migrator:
    build:
      context: '/home/tulio/code/wallet-service/'
      dockerfile: 'db/Dockerfile'
      args:
        DB_ENDPOINT: "mysql"
        DB_NAME: "wallet_service"
        DB_USER: "wallet_service_user"
        DB_PASS: "password"
        DB_PORT: 3306
        FETCH_IDENTIFIERS_FROM_FULLNODE: true
    restart: "no"  # Critical: don't restart migration service
    depends_on:
      mysql:
        condition: service_healthy
    environment: # TODO: Remove this section
      DB_ENDPOINT: "mysql"
      DB_NAME: "wallet_service"
      DB_USER: "wallet_service_user"
      DB_PASS: "password"
      DB_PORT: 3306
    networks:
      - hathor-privnet

  ws-daemon:
    build:
      context: '/home/tulio/code/wallet-service/'
      dockerfile: Dockerfile
    depends_on:
      ws-migrator:
        condition: service_completed_successfully
      fullnode:
        condition: service_healthy
      mysql:
        condition: service_healthy
    environment:
      FETCH_FULLNODE_IDS: true
      FULLNODE_HOST: "fullnode:8080"
      FULLNODE_NETWORK: "nano-testnet-alpha"
      USE_SSL: "false"
      NEW_TX_SQS: ""
      PUSH_NOTIFICATION_ENABLED: "false"
      WALLET_SERVICE_LAMBDA_ENDPOINT: ""
      ACCOUNT_ID: 1234
      ALERT_MANAGER_TOPIC: "alert-topic"
      ALERT_MANAGER_REGION: "us-east-1"
      APPLICATION_NAME: "hathor-wallet-service"
      DB_ENDPOINT: "mysql"
      DB_NAME: "wallet_service"
      DB_USER: "wallet_service_user"
      DB_PASS: "password"
      DB_PORT: 3306
#      STREAM_ID: "4a0407fc-6a11-4d4a-9f6a-f25cfac8cc1f"
#      FULLNODE_PEER_ID: "c00cbc3624aca6defcae0c908da66291e3774ab5a855c123267c1dd5ca6a2196"

      NODE_ENV: "test-privnet"
      STAGE: "local"
      MAX_ADDRESS_GAP: 10
      NETWORK: "privatenet"
#      BLOCK_REWARD_LOCK: 1
      REDIS_URL: redis://redis:6379
    ports:
      - "8081:8081"
      - "8082:8082"
    networks:
      - hathor-privnet

  ws-serverless:
    build:
      context: '/home/tulio/code/wallet-service/'
      dockerfile: 'packages/wallet-service/Dockerfile'
    depends_on:
      ws-daemon:
        condition: service_started # TODO: Implement healthcheck
    environment:
      STAGE: local
      NETWORK: testnet
      SERVICE_NAME: hathor-wallet-service
      MAX_ADDRESS_GAP: 10
      VOIDED_TX_OFFSET: 5
      BLOCK_REWARD_LOCK: 300
      CONFIRM_FIRST_ADDRESS: false
      WS_DOMAIN: http://fakehost:3002
      DEFAULT_SERVER: fullnode
      DB_ENDPOINT: mysql
      DB_NAME: wallet_service
      DB_USER: wallet_service_user
      DB_PASS: password
      DB_PORT: 3306
      REDIS_URL: redis
      REDIS_PORT: 6379
      AUTH_SECRET: foobar
      EXPLORER_SERVICE_LAMBDA_ENDPOINT: http://fakehost:3001
      WALLET_SERVICE_LAMBDA_ENDPOINT: http://fakehost:3000
      PUSH_NOTIFICATION: false
      NODE_ENV: test
      DEV_DB: mysql
      FIREBASE_PROJECT_ID: "fake_project_id"
      FIREBASE_PRIVATE_KEY_ID: "fake_private_key_id"
      FIREBASE_PRIVATE_KEY: "fake_private_key"
      FIREBASE_CLIENT_EMAIL: "fake@client_email.com"
      FIREBASE_CLIENT_ID: "fake_client_id"
      FIREBASE_AUTH_URI: "fake_auth_uri"
      FIREBASE_TOKEN_URI: "fake_token_uri"
      FIREBASE_AUTH_PROVIDER_X509_CERT_URL: "fake_auth_provider_x509_cert_url"
      FIREBASE_CLIENT_X509_CERT_URL: "fake_client_x509_cert_url"
      APPLICATION_NAME: "hathor-wallet-service"
      ACCOUNT_ID: 1234
      ALERT_MANAGER_REGION: us-east-1
      ALERT_MANAGER_TOPIC: alert-topic
      PUSH_ALLOWED_PROVIDERS: "fake_provider"
      REDIS_PASSWORD: ""
      IS_OFFLINE: true
      MOCK_AWS: true # Necessary to avoid calls to AWS on this private network
      ALERT_MANAGER_ACCOUNT_ID: "fake_account_id"
      AWS_VPC_DEFAULT_SG_ID: "1"
      AWS_SUBNET_ID_1: "2"
      AWS_SUBNET_ID_2: "3"
      AWS_SUBNET_ID_3: "4"
      NFT_AUTO_REVIEW_ENABLED: "false"
      TX_HISTORY_MAX_COUNT: ""
      PUSH_NOTIFICATION_ENABLED: "false"
      LOG_LEVEL: "debug"
      AWS_ACCESS_KEY_ID: fake-access-key-id
      AWS_SECRET_ACCESS_KEY: fake-secret-access-key
      AWS_REGION: us-east-1
      AWS_SHARED_CREDENTIALS_FILE: ".aws/credentials" # Credentials for mocked AWS
      AWS_CONFIG_FILE: ".aws/config" # Config for mocked AWS
    ports:
      - "3000:3000"
      - "3001:3001"
    networks:
      - hathor-privnet

networks:
  hathor-privnet:
